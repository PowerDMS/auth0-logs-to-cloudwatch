module.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}return n.m=e,n.c=t,n.p="/build/",n(0)}([function(e,t,n){"use strict";var r;function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n(1);var i=n(2),u=n(3),a=(n(4),n(5)),c=n(6),s=a(),l=n(7),f=n(8),p=(n(7),n(9)),h=n(10),d=null;function v(e,t){var n=e.webtaskContext,r=["AUTH0_DOMAIN","AUTH0_CLIENT_ID","AUTH0_CLIENT_SECRET","AWS_ACCESS_KEY","AWS_SECRET_KEY","AWS_REGION"].filter(function(e){return!n.data[e]});if(!d){var o=n.data.AWS_ACCESS_KEY,a=n.data.AWS_SECRET_KEY,c=n.data.AWS_REGION,s=n.data.LOG_GROUP||"AUTH0_GROUP",f=n.data.LOG_STREAM||n.data.AUTH0_DOMAIN;h.config({aws:{accessKeyId:o,secretAccessKey:a,region:c}}),d=h.getOrCreate(s)}if(r.length)return t.status(400).send({message:"Missing settings: "+r.join(", ")});e.webtaskContext.storage.get(function(r,o){var a=n.data.START_FROM?n.data.START_FROM:null,c=void 0===o?a:o.checkpointId;i.waterfall([function(t){!function(r){console.log("Logs from: "+(r.checkpointId||"Start")+".");var o=Number.parseInt(n.data.BATCH_SIZE);o=o>100?100:o,r.logs=r.logs||[],function(e,t,n,r,o){l({method:"GET",url:"https://"+e+"/api/v2/logs",json:!0,qs:{take:n,from:r,sort:"date:1",per_page:n},headers:{Authorization:"Bearer "+t,Accept:"application/json"}},function(e,t,n){e?(console.log("Error getting logs",e),o(null,e)):o(n)})}(e.webtaskContext.data.AUTH0_DOMAIN,e.access_token,o,r.checkpointId,function(e,n){return n?t({error:n,message:"Error getting logs from Auth0"}):(e&&e.length&&(e.forEach(function(e){return r.logs.push(e)}),r.checkpointId=r.logs[r.logs.length-1]._id),console.log("Total logs: "+r.logs.length+"."),t(null,r))})}({checkpointId:c})},function(e,t){var r=parseInt(n.data.LOG_LEVEL)||0,o=n.data.LOG_TYPES&&n.data.LOG_TYPES.split(",")||[];e.logs=e.logs.filter(function(e){return!m[e.type]||m[e.type].level>=r}).filter(function(e){return!o||!o.length||e.type&&o.indexOf(e.type)>=0}),t(null,e)},function(e,t){console.log("Uploading blobs...");var n=Date.now();i.eachLimit(e.logs,100,function(e,t){var r=u(e.date),o=(r.format("YYYY/MM/DD"),r.format("HH"),e._id,{});o.post_date=n,o.message=JSON.stringify(e);try{d.log(f,o.message)}catch(e){return t(e)}return t()},function(n){return n?t({error:n,message:"Error sending logs to CloudWatch"}):(console.log("Upload complete."),t(null,e))})}],function(n,r){return n?(console.log("Job failed.",n),e.webtaskContext.storage.set({checkpointId:c},{force:1},function(e){if(e)return t.status(500).send({error:e,message:"Error storing startCheckpoint"});t.status(500).send(n)})):(console.log("Job complete."),e.webtaskContext.storage.set({checkpointId:r.checkpointId,totalLogsProcessed:r.logs.length},{force:1},function(e){if(e)return t.status(500).send({error:e,message:"Error storing checkpoint"});t.sendStatus(200)}))})})}var m=(o(r={s:{event:"Success Login",level:1},seacft:{event:"Success Exchange",level:1},seccft:{event:"Success Exchange (Client Credentials)",level:1},feacft:{event:"Failed Exchange",level:3},feccft:{event:"Failed Exchange (Client Credentials)",level:3},f:{event:"Failed Login",level:3},w:{event:"Warnings During Login",level:2},du:{event:"Deleted User",level:1},fu:{event:"Failed Login (invalid email/username)",level:3},fp:{event:"Failed Login (wrong password)",level:3},fc:{event:"Failed by Connector",level:3},fco:{event:"Failed by CORS",level:3},con:{event:"Connector Online",level:1},coff:{event:"Connector Offline",level:3},fcpro:{event:"Failed Connector Provisioning",level:4},ss:{event:"Success Signup",level:1},fs:{event:"Failed Signup",level:3},cs:{event:"Code Sent",level:0},cls:{event:"Code/Link Sent",level:0},sv:{event:"Success Verification Email",level:0},fv:{event:"Failed Verification Email",level:0},scp:{event:"Success Change Password",level:1},fcp:{event:"Failed Change Password",level:3},sce:{event:"Success Change Email",level:1},fce:{event:"Failed Change Email",level:3},scu:{event:"Success Change Username",level:1},fcu:{event:"Failed Change Username",level:3},scpn:{event:"Success Change Phone Number",level:1},fcpn:{event:"Failed Change Phone Number",level:3},svr:{event:"Success Verification Email Request",level:0},fvr:{event:"Failed Verification Email Request",level:3},scpr:{event:"Success Change Password Request",level:0},fcpr:{event:"Failed Change Password Request",level:3},fn:{event:"Failed Sending Notification",level:3},sapi:{event:"API Operation",level:1},fapi:{event:"Failed API Operation",level:3},limit_wc:{event:"Blocked Account",level:4},limit_ui:{event:"Too Many Calls to /userinfo",level:4},api_limit:{event:"Rate Limit On API",level:4},sdu:{event:"Successful User Deletion",level:1},fdu:{event:"Failed User Deletion",level:3}},"fapi",{event:"Failed API Operation",level:3}),o(r,"limit_wc",{event:"Blocked Account",level:3}),o(r,"limit_mu",{event:"Blocked IP Address",level:3}),o(r,"slo",{event:"Success Logout",level:1}),o(r,"flo",{event:" Failed Logout",level:3}),o(r,"sd",{event:"Success Delegation",level:1}),o(r,"fd",{event:"Failed Delegation",level:3}),r);var y=f({load:function(e,t,n,r,o){l({method:"POST",url:e,json:!0,body:{audience:t,grant_type:"client_credentials",client_id:n,client_secret:r}},function(e,t,n){e?o(null,e):o(n.access_token)})},hash:function(e){return e},max:100,maxAge:36e5});s.use(function(e,t,n){var r="https://"+e.webtaskContext.data.AUTH0_DOMAIN+"/oauth/token",o="https://"+e.webtaskContext.data.AUTH0_DOMAIN+"/api/v2/",i=e.webtaskContext.data.AUTH0_CLIENT_ID,u=e.webtaskContext.data.AUTH0_CLIENT_SECRET;y(r,o,i,u,function(t,r){if(r)return console.log("Error getting access_token",r),n(r);e.access_token=t,n()})}),s.get("/",v),s.post("/",v),s.get("/meta",function(e,t){t.status(200).send(p)}),e.exports=c.fromExpress(s)},function(e,t){e.exports=require("winston")},function(e,t){e.exports=require("async")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("useragent")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("webtask-tools")},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("lru-memoizer")},function(e,t){e.exports={title:"Auth0 Logs to AWS CloudWatch",name:"auth0-logs-to-cloudwatch",version:"1.0.1",author:"saltuk, bbeck",description:"This extension will take all of your Auth0 logs and export them to AWS CloudWatch",type:"cron",repository:"https://github.com/PowerDMS/auth0-logs-to-cloudwatch",keywords:["auth0","extension"],schedule:"0 */5 * * * *",auth0:{scopes:"read:logs"},secrets:{BATCH_SIZE:{description:"The ammount of logs to be read on each execution. Maximun is 100.",default:100},LOG_LEVEL:{description:"This allows you to specify the log level of events that need to be sent",type:"select",allowMultiple:!0,options:[{value:"-",text:""},{value:"0",text:"Debug"},{value:"1",text:"Info"},{value:"2",text:"Warning"},{value:"3",text:"Error"},{value:"4",text:"Critical"}]},LOG_TYPES:{description:"If you only want to send events with a specific type (eg: failed logins)",type:"select",allowMultiple:!0,options:[{value:"-",text:""},{value:"s",text:"Success Login (Info)"},{value:"seacft",text:"Success Exchange (Info)"},{value:"feacft",text:"Failed Exchange (Error)"},{value:"f",text:"Failed Login (Error)"},{value:"w",text:"Warnings During Login (Warning)"},{value:"du",text:"Deleted User (Info)"},{value:"fu",text:"Failed Login (invalid email/username) (Error)"},{value:"fp",text:"Failed Login (wrong password) (Error)"},{value:"fc",text:"Failed by Connector (Error)"},{value:"fco",text:"Failed by CORS (Error)"},{value:"con",text:"Connector Online (Info)"},{value:"coff",text:"Connector Offline (Error)"},{value:"fcpro",text:"Failed Connector Provisioning (Critical)"},{value:"ss",text:"Success Signup (Info)"},{value:"fs",text:"Failed Signup (Error)"},{value:"cs",text:"Code Sent (Debug)"},{value:"cls",text:"Code/Link Sent (Debug)"},{value:"sv",text:"Success Verification Email (Debug)"},{value:"fv",text:"Failed Verification Email (Debug)"},{value:"scp",text:"Success Change Password (Info)"},{value:"fcp",text:"Failed Change Password (Error)"},{value:"sce",text:"Success Change Email (Info)"},{value:"fce",text:"Failed Change Email (Error)"},{value:"scu",text:"Success Change Username (Info)"},{value:"fcu",text:"Failed Change Username (Error)"},{value:"scpn",text:"Success Change Phone Number (Info)"},{value:"fcpn",text:"Failed Change Phone Number (Error)"},{value:"svr",text:"Success Verification Email Request (Debug)"},{value:"fvr",text:"Failed Verification Email Request (Error)"},{value:"scpr",text:"Success Change Password Request (Debug)"},{value:"fcpr",text:"Failed Change Password Request (Error)"},{value:"fn",text:"Failed Sending Notification (Error)"},{value:"limit_wc",text:"Blocked Account (Critical)"},{value:"limit_ui",text:"Too Many Calls to /userinfo (Critical)"},{value:"api_limit",text:"Rate Limit On API (Critical)"},{value:"sdu",text:"Successful User Deletion (Info)"},{value:"fdu",text:"Failed User Deletion (Error)"}]},START_FROM:{description:"The Auth0 LogId from where you want to start."},AWS_ACCESS_KEY:{description:"AWS access key"},AWS_SECRET_KEY:{description:"AWS secret key"},AWS_REGION:{description:"AWS cloudwatch region"},LOG_GROUP:{description:"Log group"},LOG_STREAM:{description:"Log stream"}}}},function(e,t,n){var r,o=n(11),i=n(12),u=n(13),a=n(14),c=n(15),s=n(17).EventEmitter,l=n(18),f=5e3,p={},h={aws:{timeout:f},cloudwatch:{}},d="DataAlreadyAcceptedException",v="InvalidSequenceTokenException";function m(e){var t=this;this.showDebugLogs=!1,this.uploadMaxTimer=5e3,this.uploadBatchSize=500;e=e;var n=!1,s={},l={},p=new u.Subject,m=p;this.__defineGetter__("settings",function(){return h});var y=function(){t.showDebugLogs&&console.log.apply(t,arguments)},g=function(o){y(e,">> uploadQueuedLogs triggered with ",o.length," logs");var u,a=i(!0);n||(a=(u=e,function(e){y("Checking if log group exists:",e);var t=i.defer(),n={logGroupNamePrefix:e};return r.describeLogGroups(n,function(e,n){e?t.reject(e):t.resolve(n.logGroups.length>0)}),t.promise.timeout(h.aws.timeout||f,"Could not communicate with AWS CloudWatch in a timely fashion")}(u).then(function(e){if(!e)return function(e){y("Creating log group:",e);var t=i.defer();return r.createLogGroup({logGroupName:e},function(n,r){n?t.reject(n):t.resolve(e)}),t.promise.timeout(h.aws.timeout||f,"Could not create log group in a timely fashion")}(u)})).then(function(){n=!0}).catch(function(e){console.error(e)})),a.then(function(){c.from(o).groupBy("$.type").forEach(function(n){var o=n.key(),u=n.getSource(),a=i(!0);o in s||(a=function(e,t){return function(e,t){y("Checking if log stream exists:",t);var n=i.defer(),o={logGroupName:e,logStreamNamePrefix:t};return r.describeLogStreams(o,function(e,t){e?n.reject(e):n.resolve(t.logStreams.length>0)}),n.promise.timeout(h.aws.timeout||f,"Could not communicate with AWS in a timely fashion")}(e,t).then(function(n){if(!n)return function(e,t){y("Creating log stream:",t);var n=i.defer();return r.createLogStream({logGroupName:e,logStreamName:t},function(e,r){e?n.reject(e):n.resolve(t)}),n.promise.timeout(h.aws.timeout||f,"Could not create log stream in a timely fashion")}(e,t)})}(e,o).then(function(){s[o]=!0}).catch(function(e){console.error(e)})),a.then(function(){u.forEach(function(e){delete e.type}),function e(t,n,o,u){y("Uploading logs");var a=i.defer();var c={logEvents:o,logGroupName:t,logStreamName:n};void 0!==u&&"string"==typeof u&&(c.sequenceToken=u);r.putLogEvents(c,function(r,i){if(r)if(r.code===d||r.code===v){var u=r.message.split(": ")[1];y("Getting sequence token",u),a.resolve(e(t,n,o,u))}else console.error(r),a.reject(r);else a.resolve(i)});return a.promise.timeout(h.aws.timeout||f,"Could not communicate with AWS in a timely fashion")}(e,o,u,l[o]).then(function(e){l[o]=e.nextSequenceToken,y("Logs uploaded"),t.emit("uploaded")}).catch(function(e){console.log(e)})})})})},w=m.subscribe(g);this.config=function(e){a(this,e),e.settings&&(h=e.settings),o.config.update(h.aws),r=new o.CloudWatchLogs({apiVersion:"2015-01-28"}),"function"==typeof w.dispose&&(w.dispose(),y("Disposed subscription")),m=p.windowWithTimeOrCount(t.uploadMaxTimer,t.uploadBatchSize).selectMany(function(e){return e.toArray()}).where(function(e){return e.length>0}),w=m.subscribe(g),y("Resubscribed")},this.log=function(e,t){t={message:"string"==typeof t?t:JSON.stringify(t),timestamp:(new Date).getTime(),type:e},p.onNext(t)},this.config({})}l.inherits(m,s),e.exports={getOrCreate:function(e){return p.hasOwnProperty(e)||(p[e]=new m(e)),p[e]},config:function(e){a(!0,h,e)}}},function(e,t){e.exports=require("aws-sdk")},function(e,t){e.exports=require("q")},function(e,t){e.exports=require("rx")},function(e,t){e.exports=require("extend")},function(e,t,n){var r;!function(o,i){var u={Identity:function(e){return e},True:function(){return!0},Blank:function(){}},a=typeof!0,c="number",s="string",l=typeof{},f="undefined",p="function",h={"":u.Identity},d={createLambda:function(e){if(null==e)return u.Identity;if(typeof e===s){var t=h[e];if(null!=t)return t;if(-1===e.indexOf("=>")){for(var n,r=new RegExp("[$]+","g"),o=0;null!=(n=r.exec(e));){var i=n[0].length;i>o&&(o=i)}for(var a=[],c=1;c<=o;c++){for(var l="",f=0;f<c;f++)l+="$";a.push(l)}var p=Array.prototype.join.call(a,",");return t=new Function(p,"return "+e),h[e]=t,t}var d=e.match(/^[(\s]*([^()]*?)[)\s]*=>(.*)/);return t=new Function(d[1],"return "+d[2]),h[e]=t,t}return e},isIEnumerable:function(e){if(typeof Enumerator!==f)try{return new Enumerator(e),!0}catch(e){}return!1},defineProperty:null!=Object.defineProperties?function(e,t,n){Object.defineProperty(e,t,{enumerable:!1,configurable:!0,writable:!0,value:n})}:function(e,t,n){e[t]=n},compare:function(e,t){return e===t?0:e>t?1:-1},dispose:function(e){null!=e&&e.dispose()}},v=0,m=1,y=2,g=function(e,t,n){var r=new w,o=v;this.current=r.current,this.moveNext=function(){try{switch(o){case v:o=m,e();case m:return!!t.apply(r)||(this.dispose(),!1);case y:return!1}}catch(e){throw this.dispose(),e}},this.dispose=function(){if(o==m)try{n()}finally{o=y}}},w=function(){var e=null;this.current=function(){return e},this.yieldReturn=function(t){return e=t,!0},this.yieldBreak=function(){return!1}},E=function(e){this.getEnumerator=e};(E.Utils={}).createLambda=function(e){return d.createLambda(e)},E.Utils.createEnumerable=function(e){return new E(e)},E.Utils.createEnumerator=function(e,t,n){return new g(e,t,n)},E.Utils.extendTo=function(e){var t,n=e.prototype;for(var r in e===Array?(t=S.prototype,d.defineProperty(n,"getSource",function(){return this})):(t=E.prototype,d.defineProperty(n,"getEnumerator",function(){return E.from(this).getEnumerator()})),t){var o=t[r];n[r]!=o&&(null!=n[r]&&n[r+="ByLinq"]==o||o instanceof Function&&d.defineProperty(n,r,o))}},E.choice=function(){var e=arguments;return new E(function(){return new g(function(){e=e[0]instanceof Array?e[0]:null!=e[0].getEnumerator?e[0].toArray():e},function(){return this.yieldReturn(e[Math.floor(Math.random()*e.length)])},u.Blank)})},E.cycle=function(){var e=arguments;return new E(function(){var t=0;return new g(function(){e=e[0]instanceof Array?e[0]:null!=e[0].getEnumerator?e[0].toArray():e},function(){return t>=e.length&&(t=0),this.yieldReturn(e[t++])},u.Blank)})},E.empty=function(){return new E(function(){return new g(u.Blank,function(){return!1},u.Blank)})},E.from=function(e){if(null==e)return E.empty();if(e instanceof E)return e;if(typeof e==c||typeof e==a)return E.repeat(e,1);if(typeof e==s)return new E(function(){var t=0;return new g(u.Blank,function(){return t<e.length&&this.yieldReturn(e.charAt(t++))},u.Blank)});if(typeof e!=p){if(typeof e.length==c)return new S(e);if(!(e instanceof Object)&&d.isIEnumerable(e))return new E(function(){var t,n=!0;return new g(function(){t=new Enumerator(e)},function(){return n?n=!1:t.moveNext(),!t.atEnd()&&this.yieldReturn(t.item())},u.Blank)});if(typeof Windows===l&&typeof e.first===p)return new E(function(){var t,n=!0;return new g(function(){t=e.first()},function(){return n?n=!1:t.moveNext(),t.hasCurrent?this.yieldReturn(t.current):this.yieldBreak()},u.Blank)})}return new E(function(){var t=[],n=0;return new g(function(){for(var n in e){var r=e[n];r instanceof Function||!Object.prototype.hasOwnProperty.call(e,n)||t.push({key:n,value:r})}},function(){return n<t.length&&this.yieldReturn(t[n++])},u.Blank)})},E.make=function(e){return E.repeat(e,1)},E.matches=function(e,t,n){return null==n&&(n=""),t instanceof RegExp&&(n+=t.ignoreCase?"i":"",n+=t.multiline?"m":"",t=t.source),-1===n.indexOf("g")&&(n+="g"),new E(function(){var r;return new g(function(){r=new RegExp(t,n)},function(){var t=r.exec(e);return!!t&&this.yieldReturn(t)},u.Blank)})},E.range=function(e,t,n){return null==n&&(n=1),new E(function(){var r,o=0;return new g(function(){r=e-n},function(){return o++<t?this.yieldReturn(r+=n):this.yieldBreak()},u.Blank)})},E.rangeDown=function(e,t,n){return null==n&&(n=1),new E(function(){var r,o=0;return new g(function(){r=e+n},function(){return o++<t?this.yieldReturn(r-=n):this.yieldBreak()},u.Blank)})},E.rangeTo=function(e,t,n){return null==n&&(n=1),new E(e<t?function(){var r;return new g(function(){r=e-n},function(){var e=r+=n;return e<=t?this.yieldReturn(e):this.yieldBreak()},u.Blank)}:function(){var r;return new g(function(){r=e+n},function(){var e=r-=n;return e>=t?this.yieldReturn(e):this.yieldBreak()},u.Blank)})},E.repeat=function(e,t){return null!=t?E.repeat(e).take(t):new E(function(){return new g(u.Blank,function(){return this.yieldReturn(e)},u.Blank)})},E.repeatWithFinalize=function(e,t){return e=d.createLambda(e),t=d.createLambda(t),new E(function(){var n;return new g(function(){n=e()},function(){return this.yieldReturn(n)},function(){null!=n&&(t(n),n=null)})})},E.generate=function(e,t){return null!=t?E.generate(e).take(t):(e=d.createLambda(e),new E(function(){return new g(u.Blank,function(){return this.yieldReturn(e())},u.Blank)}))},E.toInfinity=function(e,t){return null==e&&(e=0),null==t&&(t=1),new E(function(){var n;return new g(function(){n=e-t},function(){return this.yieldReturn(n+=t)},u.Blank)})},E.toNegativeInfinity=function(e,t){return null==e&&(e=0),null==t&&(t=1),new E(function(){var n;return new g(function(){n=e+t},function(){return this.yieldReturn(n-=t)},u.Blank)})},E.unfold=function(e,t){return t=d.createLambda(t),new E(function(){var n,r=!0;return new g(u.Blank,function(){return r?(r=!1,n=e,this.yieldReturn(n)):(n=t(n),this.yieldReturn(n))},u.Blank)})},E.defer=function(e){return new E(function(){var t;return new g(function(){t=E.from(e()).getEnumerator()},function(){return t.moveNext()?this.yieldReturn(t.current()):this.yieldBreak()},function(){d.dispose(t)})})},E.prototype.traverseBreadthFirst=function(e,t){var n=this;return e=d.createLambda(e),t=d.createLambda(t),new E(function(){var r,o=0,i=[];return new g(function(){r=n.getEnumerator()},function(){for(;;){if(r.moveNext())return i.push(r.current()),this.yieldReturn(t(r.current(),o));var n=E.from(i).selectMany(function(t){return e(t)});if(!n.any())return!1;o++,i=[],d.dispose(r),r=n.getEnumerator()}},function(){d.dispose(r)})})},E.prototype.traverseDepthFirst=function(e,t){var n=this;return e=d.createLambda(e),t=d.createLambda(t),new E(function(){var r,o=[];return new g(function(){r=n.getEnumerator()},function(){for(;;){if(r.moveNext()){var n=t(r.current(),o.length);return o.push(r),r=E.from(e(r.current())).getEnumerator(),this.yieldReturn(n)}if(o.length<=0)return!1;d.dispose(r),r=o.pop()}},function(){try{d.dispose(r)}finally{E.from(o).forEach(function(e){e.dispose()})}})})},E.prototype.flatten=function(){var e=this;return new E(function(){var t,n=null;return new g(function(){t=e.getEnumerator()},function(){for(;;){if(null!=n){if(n.moveNext())return this.yieldReturn(n.current());n=null}if(t.moveNext()){if(t.current()instanceof Array){d.dispose(n),n=E.from(t.current()).selectMany(u.Identity).flatten().getEnumerator();continue}return this.yieldReturn(t.current())}return!1}},function(){try{d.dispose(t)}finally{d.dispose(n)}})})},E.prototype.pairwise=function(e){var t=this;return e=d.createLambda(e),new E(function(){var n;return new g(function(){(n=t.getEnumerator()).moveNext()},function(){var t=n.current();return!!n.moveNext()&&this.yieldReturn(e(t,n.current()))},function(){d.dispose(n)})})},E.prototype.scan=function(e,t){var n;null==t?(t=d.createLambda(e),n=!1):(t=d.createLambda(t),n=!0);var r=this;return new E(function(){var o,i,u=!0;return new g(function(){o=r.getEnumerator()},function(){if(u){if(u=!1,n)return this.yieldReturn(i=e);if(o.moveNext())return this.yieldReturn(i=o.current())}return!!o.moveNext()&&this.yieldReturn(i=t(i,o.current()))},function(){d.dispose(o)})})},E.prototype.select=function(e){if((e=d.createLambda(e)).length<=1)return new R(this,null,e);var t=this;return new E(function(){var n,r=0;return new g(function(){n=t.getEnumerator()},function(){return!!n.moveNext()&&this.yieldReturn(e(n.current(),r++))},function(){d.dispose(n)})})},E.prototype.selectMany=function(e,t){var n=this;return e=d.createLambda(e),null==t&&(t=function(e,t){return t}),t=d.createLambda(t),new E(function(){var r,o=void 0,i=0;return new g(function(){r=n.getEnumerator()},function(){if(void 0===o&&!r.moveNext())return!1;do{if(null==o){var n=e(r.current(),i++);o=E.from(n).getEnumerator()}if(o.moveNext())return this.yieldReturn(t(r.current(),o.current()));d.dispose(o),o=null}while(r.moveNext());return!1},function(){try{d.dispose(r)}finally{d.dispose(o)}})})},E.prototype.where=function(e){if((e=d.createLambda(e)).length<=1)return new L(this,e);var t=this;return new E(function(){var n,r=0;return new g(function(){n=t.getEnumerator()},function(){for(;n.moveNext();)if(e(n.current(),r++))return this.yieldReturn(n.current());return!1},function(){d.dispose(n)})})},E.prototype.choose=function(e){e=d.createLambda(e);var t=this;return new E(function(){var n,r=0;return new g(function(){n=t.getEnumerator()},function(){for(;n.moveNext();){var t=e(n.current(),r++);if(null!=t)return this.yieldReturn(t)}return this.yieldBreak()},function(){d.dispose(n)})})},E.prototype.ofType=function(e){var t;switch(e){case Number:t=c;break;case String:t=s;break;case Boolean:t=a;break;case Function:t=p;break;default:t=null}return null===t?this.where(function(t){return t instanceof e}):this.where(function(e){return typeof e===t})},E.prototype.zip=function(){var e=arguments,t=d.createLambda(arguments[arguments.length-1]),n=this;if(2==arguments.length){var r=arguments[0];return new E(function(){var e,o,i=0;return new g(function(){e=n.getEnumerator(),o=E.from(r).getEnumerator()},function(){return!(!e.moveNext()||!o.moveNext())&&this.yieldReturn(t(e.current(),o.current(),i++))},function(){try{d.dispose(e)}finally{d.dispose(o)}})})}return new E(function(){var r,o=0;return new g(function(){var t=E.make(n).concat(E.from(e).takeExceptLast().select(E.from)).select(function(e){return e.getEnumerator()}).toArray();r=E.from(t)},function(){if(r.all(function(e){return e.moveNext()})){var e=r.select(function(e){return e.current()}).toArray();return e.push(o++),this.yieldReturn(t.apply(null,e))}return this.yieldBreak()},function(){E.from(r).forEach(d.dispose)})})},E.prototype.merge=function(){var e=arguments,t=this;return new E(function(){var n,r=-1;return new g(function(){n=E.make(t).concat(E.from(e).select(E.from)).select(function(e){return e.getEnumerator()}).toArray()},function(){for(;n.length>0;){r=r>=n.length-1?0:r+1;var e=n[r];if(e.moveNext())return this.yieldReturn(e.current());e.dispose(),n.splice(r--,1)}return this.yieldBreak()},function(){E.from(n).forEach(d.dispose)})})},E.prototype.join=function(e,t,n,r,o){t=d.createLambda(t),n=d.createLambda(n),r=d.createLambda(r),o=d.createLambda(o);var i=this;return new E(function(){var a,c,s=null,l=0;return new g(function(){a=i.getEnumerator(),c=E.from(e).toLookup(n,u.Identity,o)},function(){for(;;){if(null!=s){var e=s[l++];if(void 0!==e)return this.yieldReturn(r(a.current(),e));e=null,l=0}if(!a.moveNext())return!1;var n=t(a.current());s=c.get(n).toArray()}},function(){d.dispose(a)})})},E.prototype.groupJoin=function(e,t,n,r,o){t=d.createLambda(t),n=d.createLambda(n),r=d.createLambda(r),o=d.createLambda(o);var i=this;return new E(function(){var a=i.getEnumerator(),c=null;return new g(function(){a=i.getEnumerator(),c=E.from(e).toLookup(n,u.Identity,o)},function(){if(a.moveNext()){var e=c.get(t(a.current()));return this.yieldReturn(r(a.current(),e))}return!1},function(){d.dispose(a)})})},E.prototype.all=function(e){e=d.createLambda(e);var t=!0;return this.forEach(function(n){if(!e(n))return t=!1,!1}),t},E.prototype.any=function(e){e=d.createLambda(e);var t=this.getEnumerator();try{if(0==arguments.length)return t.moveNext();for(;t.moveNext();)if(e(t.current()))return!0;return!1}finally{d.dispose(t)}},E.prototype.isEmpty=function(){return!this.any()},E.prototype.concat=function(){var e=this;if(1==arguments.length){var t=arguments[0];return new E(function(){var n,r;return new g(function(){n=e.getEnumerator()},function(){if(null==r){if(n.moveNext())return this.yieldReturn(n.current());r=E.from(t).getEnumerator()}return!!r.moveNext()&&this.yieldReturn(r.current())},function(){try{d.dispose(n)}finally{d.dispose(r)}})})}var n=arguments;return new E(function(){var t;return new g(function(){t=E.make(e).concat(E.from(n).select(E.from)).select(function(e){return e.getEnumerator()}).toArray()},function(){for(;t.length>0;){var e=t[0];if(e.moveNext())return this.yieldReturn(e.current());e.dispose(),t.splice(0,1)}return this.yieldBreak()},function(){E.from(t).forEach(d.dispose)})})},E.prototype.insert=function(e,t){var n=this;return new E(function(){var r,o,i=0,u=!1;return new g(function(){r=n.getEnumerator(),o=E.from(t).getEnumerator()},function(){return i==e&&o.moveNext()?(u=!0,this.yieldReturn(o.current())):r.moveNext()?(i++,this.yieldReturn(r.current())):!(u||!o.moveNext())&&this.yieldReturn(o.current())},function(){try{d.dispose(r)}finally{d.dispose(o)}})})},E.prototype.alternate=function(e){var t=this;return new E(function(){var n,r,o,i;return new g(function(){o=e instanceof Array||null!=e.getEnumerator?E.from(E.from(e).toArray()):E.make(e),(r=t.getEnumerator()).moveNext()&&(n=r.current())},function(){for(;;){if(null!=i){if(i.moveNext())return this.yieldReturn(i.current());i=null}if(null!=n||!r.moveNext()){if(null!=n){var e=n;return n=null,this.yieldReturn(e)}return this.yieldBreak()}n=r.current(),i=o.getEnumerator()}},function(){try{d.dispose(r)}finally{d.dispose(i)}})})},E.prototype.contains=function(e,t){t=d.createLambda(t);var n=this.getEnumerator();try{for(;n.moveNext();)if(t(n.current())===e)return!0;return!1}finally{d.dispose(n)}},E.prototype.defaultIfEmpty=function(e){var t=this;return void 0===e&&(e=null),new E(function(){var n,r=!0;return new g(function(){n=t.getEnumerator()},function(){return n.moveNext()?(r=!1,this.yieldReturn(n.current())):!!r&&(r=!1,this.yieldReturn(e))},function(){d.dispose(n)})})},E.prototype.distinct=function(e){return this.except(E.empty(),e)},E.prototype.distinctUntilChanged=function(e){e=d.createLambda(e);var t=this;return new E(function(){var n,r,o;return new g(function(){n=t.getEnumerator()},function(){for(;n.moveNext();){var t=e(n.current());if(o)return o=!1,r=t,this.yieldReturn(n.current());if(r!==t)return r=t,this.yieldReturn(n.current())}return this.yieldBreak()},function(){d.dispose(n)})})},E.prototype.except=function(e,t){t=d.createLambda(t);var n=this;return new E(function(){var r,o;return new g(function(){r=n.getEnumerator(),o=new N(t),E.from(e).forEach(function(e){o.add(e)})},function(){for(;r.moveNext();){var e=r.current();if(!o.contains(e))return o.add(e),this.yieldReturn(e)}return!1},function(){d.dispose(r)})})},E.prototype.intersect=function(e,t){t=d.createLambda(t);var n=this;return new E(function(){var r,o,i;return new g(function(){r=n.getEnumerator(),o=new N(t),E.from(e).forEach(function(e){o.add(e)}),i=new N(t)},function(){for(;r.moveNext();){var e=r.current();if(!i.contains(e)&&o.contains(e))return i.add(e),this.yieldReturn(e)}return!1},function(){d.dispose(r)})})},E.prototype.sequenceEqual=function(e,t){t=d.createLambda(t);var n=this.getEnumerator();try{var r=E.from(e).getEnumerator();try{for(;n.moveNext();)if(!r.moveNext()||t(n.current())!==t(r.current()))return!1;return!r.moveNext()}finally{d.dispose(r)}}finally{d.dispose(n)}},E.prototype.union=function(e,t){t=d.createLambda(t);var n=this;return new E(function(){var r,o,i;return new g(function(){r=n.getEnumerator(),i=new N(t)},function(){var t;if(void 0===o){for(;r.moveNext();)if(t=r.current(),!i.contains(t))return i.add(t),this.yieldReturn(t);o=E.from(e).getEnumerator()}for(;o.moveNext();)if(t=o.current(),!i.contains(t))return i.add(t),this.yieldReturn(t);return!1},function(){try{d.dispose(r)}finally{d.dispose(o)}})})},E.prototype.orderBy=function(e){return new x(this,e,!1)},E.prototype.orderByDescending=function(e){return new x(this,e,!0)},E.prototype.reverse=function(){var e=this;return new E(function(){var t,n;return new g(function(){t=e.toArray(),n=t.length},function(){return n>0&&this.yieldReturn(t[--n])},u.Blank)})},E.prototype.shuffle=function(){var e=this;return new E(function(){var t;return new g(function(){t=e.toArray()},function(){if(t.length>0){var e=Math.floor(Math.random()*t.length);return this.yieldReturn(t.splice(e,1)[0])}return!1},u.Blank)})},E.prototype.weightedSample=function(e){e=d.createLambda(e);var t=this;return new E(function(){var n,r=0;return new g(function(){n=t.choose(function(t){var n=e(t);return n<=0?null:{value:t,bound:r+=n}}).toArray()},function(){if(n.length>0){for(var e=Math.floor(Math.random()*r)+1,t=-1,o=n.length;o-t>1;){var i=Math.floor((t+o)/2);n[i].bound>=e?o=i:t=i}return this.yieldReturn(n[o].value)}return this.yieldBreak()},u.Blank)})},E.prototype.groupBy=function(e,t,n,r){var o=this;return e=d.createLambda(e),t=d.createLambda(t),null!=n&&(n=d.createLambda(n)),r=d.createLambda(r),new E(function(){var i;return new g(function(){i=o.toLookup(e,t,r).toEnumerable().getEnumerator()},function(){for(;i.moveNext();)return null==n?this.yieldReturn(i.current()):this.yieldReturn(n(i.current().key(),i.current()));return!1},function(){d.dispose(i)})})},E.prototype.partitionBy=function(e,t,n,r){var o,i=this;return e=d.createLambda(e),t=d.createLambda(t),r=d.createLambda(r),null==n?(o=!1,n=function(e,t){return new C(e,t)}):(o=!0,n=d.createLambda(n)),new E(function(){var u,a,c,s=[];return new g(function(){(u=i.getEnumerator()).moveNext()&&(a=e(u.current()),c=r(a),s.push(t(u.current())))},function(){for(var i;1==(i=u.moveNext())&&c===r(e(u.current()));)s.push(t(u.current()));if(s.length>0){var l=n(a,o?E.from(s):s);return i?(a=e(u.current()),c=r(a),s=[t(u.current())]):s=[],this.yieldReturn(l)}return!1},function(){d.dispose(u)})})},E.prototype.buffer=function(e){var t=this;return new E(function(){var n;return new g(function(){n=t.getEnumerator()},function(){for(var t=[],r=0;n.moveNext();)if(t.push(n.current()),++r>=e)return this.yieldReturn(t);return t.length>0&&this.yieldReturn(t)},function(){d.dispose(n)})})},E.prototype.aggregate=function(e,t,n){return(n=d.createLambda(n))(this.scan(e,t,n).last())},E.prototype.average=function(e){e=d.createLambda(e);var t=0,n=0;return this.forEach(function(r){t+=e(r),++n}),t/n},E.prototype.count=function(e){e=null==e?u.True:d.createLambda(e);var t=0;return this.forEach(function(n,r){e(n,r)&&++t}),t},E.prototype.max=function(e){return null==e&&(e=u.Identity),this.select(e).aggregate(function(e,t){return e>t?e:t})},E.prototype.min=function(e){return null==e&&(e=u.Identity),this.select(e).aggregate(function(e,t){return e<t?e:t})},E.prototype.maxBy=function(e){return e=d.createLambda(e),this.aggregate(function(t,n){return e(t)>e(n)?t:n})},E.prototype.minBy=function(e){return e=d.createLambda(e),this.aggregate(function(t,n){return e(t)<e(n)?t:n})},E.prototype.sum=function(e){return null==e&&(e=u.Identity),this.select(e).aggregate(0,function(e,t){return e+t})},E.prototype.elementAt=function(e){var t,n=!1;if(this.forEach(function(r,o){if(o==e)return t=r,n=!0,!1}),!n)throw new Error("index is less than 0 or greater than or equal to the number of elements in source.");return t},E.prototype.elementAtOrDefault=function(e,t){var n;void 0===t&&(t=null);var r=!1;return this.forEach(function(t,o){if(o==e)return n=t,r=!0,!1}),r?n:t},E.prototype.first=function(e){if(null!=e)return this.where(e).first();var t,n=!1;if(this.forEach(function(e){return t=e,n=!0,!1}),!n)throw new Error("first:No element satisfies the condition.");return t},E.prototype.firstOrDefault=function(e,t){if(void 0!==e){if(typeof e===p||typeof d.createLambda(e)===p)return this.where(e).firstOrDefault(void 0,t);t=e}var n,r=!1;return this.forEach(function(e){return n=e,r=!0,!1}),r?n:t},E.prototype.last=function(e){if(null!=e)return this.where(e).last();var t,n=!1;if(this.forEach(function(e){n=!0,t=e}),!n)throw new Error("last:No element satisfies the condition.");return t},E.prototype.lastOrDefault=function(e,t){if(void 0!==e){if(typeof e===p||typeof d.createLambda(e)===p)return this.where(e).lastOrDefault(void 0,t);t=e}var n,r=!1;return this.forEach(function(e){r=!0,n=e}),r?n:t},E.prototype.single=function(e){if(null!=e)return this.where(e).single();var t,n=!1;if(this.forEach(function(e){if(n)throw new Error("single:sequence contains more than one element.");n=!0,t=e}),!n)throw new Error("single:No element satisfies the condition.");return t},E.prototype.singleOrDefault=function(e,t){if(void 0===t&&(t=null),null!=e)return this.where(e).singleOrDefault(null,t);var n,r=!1;return this.forEach(function(e){if(r)throw new Error("single:sequence contains more than one element.");r=!0,n=e}),r?n:t},E.prototype.skip=function(e){var t=this;return new E(function(){var n,r=0;return new g(function(){for(n=t.getEnumerator();r++<e&&n.moveNext(););},function(){return!!n.moveNext()&&this.yieldReturn(n.current())},function(){d.dispose(n)})})},E.prototype.skipWhile=function(e){e=d.createLambda(e);var t=this;return new E(function(){var n,r=0,o=!1;return new g(function(){n=t.getEnumerator()},function(){for(;!o;){if(!n.moveNext())return!1;if(!e(n.current(),r++))return o=!0,this.yieldReturn(n.current())}return!!n.moveNext()&&this.yieldReturn(n.current())},function(){d.dispose(n)})})},E.prototype.take=function(e){var t=this;return new E(function(){var n,r=0;return new g(function(){n=t.getEnumerator()},function(){return!!(r++<e&&n.moveNext())&&this.yieldReturn(n.current())},function(){d.dispose(n)})})},E.prototype.takeWhile=function(e){e=d.createLambda(e);var t=this;return new E(function(){var n,r=0;return new g(function(){n=t.getEnumerator()},function(){return!(!n.moveNext()||!e(n.current(),r++))&&this.yieldReturn(n.current())},function(){d.dispose(n)})})},E.prototype.takeExceptLast=function(e){null==e&&(e=1);var t=this;return new E(function(){if(e<=0)return t.getEnumerator();var n,r=[];return new g(function(){n=t.getEnumerator()},function(){for(;n.moveNext();){if(r.length==e)return r.push(n.current()),this.yieldReturn(r.shift());r.push(n.current())}return!1},function(){d.dispose(n)})})},E.prototype.takeFromLast=function(e){if(e<=0||null==e)return E.empty();var t=this;return new E(function(){var n,r,o=[];return new g(function(){n=t.getEnumerator()},function(){for(;n.moveNext();)o.length==e&&o.shift(),o.push(n.current());return null==r&&(r=E.from(o).getEnumerator()),!!r.moveNext()&&this.yieldReturn(r.current())},function(){d.dispose(r)})})},E.prototype.indexOf=function(e){var t=null;return typeof e===p?this.forEach(function(n,r){if(e(n,r))return t=r,!1}):this.forEach(function(n,r){if(n===e)return t=r,!1}),null!==t?t:-1},E.prototype.lastIndexOf=function(e){var t=-1;return typeof e===p?this.forEach(function(n,r){e(n,r)&&(t=r)}):this.forEach(function(n,r){n===e&&(t=r)}),t},E.prototype.cast=function(){return this},E.prototype.asEnumerable=function(){return E.from(this)},E.prototype.toArray=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},E.prototype.toLookup=function(e,t,n){e=d.createLambda(e),t=d.createLambda(t),n=d.createLambda(n);var r=new N(n);return this.forEach(function(n){var o=e(n),i=t(n),u=r.get(o);void 0!==u?u.push(i):r.add(o,[i])}),new A(r)},E.prototype.toObject=function(e,t){e=d.createLambda(e),t=d.createLambda(t);var n={};return this.forEach(function(r){n[e(r)]=t(r)}),n},E.prototype.toDictionary=function(e,t,n){e=d.createLambda(e),t=d.createLambda(t),n=d.createLambda(n);var r=new N(n);return this.forEach(function(n){r.add(e(n),t(n))}),r},E.prototype.toJSONString=function(e,t){if(typeof JSON===f||null==JSON.stringify)throw new Error("toJSONString can't find JSON.stringify. This works native JSON support Browser or include json2.js");return JSON.stringify(this.toArray(),e,t)},E.prototype.toJoinedString=function(e,t){return null==e&&(e=""),null==t&&(t=u.Identity),this.select(t).toArray().join(e)},E.prototype.doAction=function(e){var t=this;return e=d.createLambda(e),new E(function(){var n,r=0;return new g(function(){n=t.getEnumerator()},function(){return!!n.moveNext()&&(e(n.current(),r++),this.yieldReturn(n.current()))},function(){d.dispose(n)})})},E.prototype.forEach=function(e){e=d.createLambda(e);var t=0,n=this.getEnumerator();try{for(;n.moveNext()&&!1!==e(n.current(),t++););}finally{d.dispose(n)}},E.prototype.write=function(e,t){null==e&&(e=""),t=d.createLambda(t);var n=!0;this.forEach(function(r){n?n=!1:document.write(e),document.write(t(r))})},E.prototype.writeLine=function(e){e=d.createLambda(e),this.forEach(function(t){document.writeln(e(t)+"<br />")})},E.prototype.force=function(){var e=this.getEnumerator();try{for(;e.moveNext(););}finally{d.dispose(e)}},E.prototype.letBind=function(e){e=d.createLambda(e);var t=this;return new E(function(){var n;return new g(function(){n=E.from(e(t)).getEnumerator()},function(){return!!n.moveNext()&&this.yieldReturn(n.current())},function(){d.dispose(n)})})},E.prototype.share=function(){var e,t=this,n=!1;return new k(function(){return new g(function(){null==e&&(e=t.getEnumerator())},function(){if(n)throw new Error("enumerator is disposed");return!!e.moveNext()&&this.yieldReturn(e.current())},u.Blank)},function(){n=!0,d.dispose(e)})},E.prototype.memoize=function(){var e,t,n=this,r=!1;return new k(function(){var o=-1;return new g(function(){null==t&&(t=n.getEnumerator(),e=[])},function(){if(r)throw new Error("enumerator is disposed");return o++,e.length<=o?!!t.moveNext()&&this.yieldReturn(e[o]=t.current()):this.yieldReturn(e[o])},u.Blank)},function(){r=!0,d.dispose(t),e=null})},E.prototype.catchError=function(e){e=d.createLambda(e);var t=this;return new E(function(){var n;return new g(function(){n=t.getEnumerator()},function(){try{return!!n.moveNext()&&this.yieldReturn(n.current())}catch(t){return e(t),!1}},function(){d.dispose(n)})})},E.prototype.finallyAction=function(e){e=d.createLambda(e);var t=this;return new E(function(){var n;return new g(function(){n=t.getEnumerator()},function(){return!!n.moveNext()&&this.yieldReturn(n.current())},function(){try{d.dispose(n)}finally{e()}})})},E.prototype.log=function(e){return e=d.createLambda(e),this.doAction(function(t){typeof console!==f&&console.log(e(t))})},E.prototype.trace=function(e,t){return null==e&&(e="Trace"),t=d.createLambda(t),this.doAction(function(n){typeof console!==f&&console.log(e,t(n))})};var x=function(e,t,n,r){this.source=e,this.keySelector=d.createLambda(t),this.descending=n,this.parent=r};x.prototype=new E,x.prototype.createOrderedEnumerable=function(e,t){return new x(this.source,e,t,this)},x.prototype.thenBy=function(e){return this.createOrderedEnumerable(e,!1)},x.prototype.thenByDescending=function(e){return this.createOrderedEnumerable(e,!0)},x.prototype.getEnumerator=function(){var e,t,n=this,r=0;return new g(function(){e=[],t=[],n.source.forEach(function(n,r){e.push(n),t.push(r)});var r=b.create(n,null);r.GenerateKeys(e),t.sort(function(e,t){return r.compare(e,t)})},function(){return r<t.length&&this.yieldReturn(e[t[r++]])},u.Blank)};var b=function(e,t,n){this.keySelector=e,this.descending=t,this.child=n,this.keys=null};b.create=function(e,t){var n=new b(e.keySelector,e.descending,t);return null!=e.parent?b.create(e.parent,n):n},b.prototype.GenerateKeys=function(e){for(var t=e.length,n=this.keySelector,r=new Array(t),o=0;o<t;o++)r[o]=n(e[o]);this.keys=r,null!=this.child&&this.child.GenerateKeys(e)},b.prototype.compare=function(e,t){var n=d.compare(this.keys[e],this.keys[t]);return 0==n?null!=this.child?this.child.compare(e,t):d.compare(e,t):this.descending?-n:n};var k=function(e,t){this.dispose=t,E.call(this,e)};k.prototype=new E;var S=function(e){this.getSource=function(){return e}};S.prototype=new E,S.prototype.any=function(e){return null==e?this.getSource().length>0:E.prototype.any.apply(this,arguments)},S.prototype.count=function(e){return null==e?this.getSource().length:E.prototype.count.apply(this,arguments)},S.prototype.elementAt=function(e){var t=this.getSource();return 0<=e&&e<t.length?t[e]:E.prototype.elementAt.apply(this,arguments)},S.prototype.elementAtOrDefault=function(e,t){void 0===t&&(t=null);var n=this.getSource();return 0<=e&&e<n.length?n[e]:t},S.prototype.first=function(e){var t=this.getSource();return null==e&&t.length>0?t[0]:E.prototype.first.apply(this,arguments)},S.prototype.firstOrDefault=function(e,t){if(void 0!==e)return E.prototype.firstOrDefault.apply(this,arguments);t=e;var n=this.getSource();return n.length>0?n[0]:t},S.prototype.last=function(e){var t=this.getSource();return null==e&&t.length>0?t[t.length-1]:E.prototype.last.apply(this,arguments)},S.prototype.lastOrDefault=function(e,t){if(void 0!==e)return E.prototype.lastOrDefault.apply(this,arguments);t=e;var n=this.getSource();return n.length>0?n[n.length-1]:t},S.prototype.skip=function(e){var t=this.getSource();return new E(function(){var n;return new g(function(){n=e<0?0:e},function(){return n<t.length&&this.yieldReturn(t[n++])},u.Blank)})},S.prototype.takeExceptLast=function(e){return null==e&&(e=1),this.take(this.getSource().length-e)},S.prototype.takeFromLast=function(e){return this.skip(this.getSource().length-e)},S.prototype.reverse=function(){var e=this.getSource();return new E(function(){var t;return new g(function(){t=e.length},function(){return t>0&&this.yieldReturn(e[--t])},u.Blank)})},S.prototype.sequenceEqual=function(e,t){return(!(e instanceof S||e instanceof Array)||null!=t||E.from(e).count()==this.count())&&E.prototype.sequenceEqual.apply(this,arguments)},S.prototype.toJoinedString=function(e,t){var n=this.getSource();return null==t&&n instanceof Array?(null==e&&(e=""),n.join(e)):E.prototype.toJoinedString.apply(this,arguments)},S.prototype.getEnumerator=function(){var e=this.getSource(),t=-1;return{current:function(){return e[t]},moveNext:function(){return++t<e.length},dispose:u.Blank}};var L=function(e,t){this.prevSource=e,this.prevPredicate=t};L.prototype=new E,L.prototype.where=function(e){if((e=d.createLambda(e)).length<=1){var t=this.prevPredicate;return new L(this.prevSource,function(n){return t(n)&&e(n)})}return E.prototype.where.call(this,e)},L.prototype.select=function(e){return(e=d.createLambda(e)).length<=1?new R(this.prevSource,this.prevPredicate,e):E.prototype.select.call(this,e)},L.prototype.getEnumerator=function(){var e,t=this.prevPredicate,n=this.prevSource;return new g(function(){e=n.getEnumerator()},function(){for(;e.moveNext();)if(t(e.current()))return this.yieldReturn(e.current());return!1},function(){d.dispose(e)})};var R=function(e,t,n){this.prevSource=e,this.prevPredicate=t,this.prevSelector=n};R.prototype=new E,R.prototype.where=function(e){return(e=d.createLambda(e)).length<=1?new L(this,e):E.prototype.where.call(this,e)},R.prototype.select=function(e){if((e=d.createLambda(e)).length<=1){var t=this.prevSelector;return new R(this.prevSource,this.prevPredicate,function(n){return e(t(n))})}return E.prototype.select.call(this,e)},R.prototype.getEnumerator=function(){var e,t=this.prevPredicate,n=this.prevSelector,r=this.prevSource;return new g(function(){e=r.getEnumerator()},function(){for(;e.moveNext();)if(null==t||t(e.current()))return this.yieldReturn(n(e.current()));return!1},function(){d.dispose(e)})};var N=function(){var e=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t=function(e){return null===e?"null":void 0===e?"undefined":typeof e.toString===p?e.toString():Object.prototype.toString.call(e)},n=function(e,t){this.key=e,this.value=t,this.prev=null,this.next=null},r=function(){this.first=null,this.last=null};r.prototype={addLast:function(e){null!=this.last?(this.last.next=e,e.prev=this.last,this.last=e):this.first=this.last=e},replace:function(e,t){null!=e.prev?(e.prev.next=t,t.prev=e.prev):this.first=t,null!=e.next?(e.next.prev=t,t.next=e.next):this.last=t},remove:function(e){null!=e.prev?e.prev.next=e.next:this.first=e.next,null!=e.next?e.next.prev=e.prev:this.last=e.prev}};var o=function(e){this.countField=0,this.entryList=new r,this.buckets={},this.compareSelector=null==e?u.Identity:e};return o.prototype={add:function(r,o){var i=this.compareSelector(r),u=t(i),a=new n(r,o);if(e(this.buckets,u)){for(var c=this.buckets[u],s=0;s<c.length;s++)if(this.compareSelector(c[s].key)===i)return this.entryList.replace(c[s],a),void(c[s]=a);c.push(a)}else this.buckets[u]=[a];this.countField++,this.entryList.addLast(a)},get:function(n){var r=this.compareSelector(n),o=t(r);if(e(this.buckets,o))for(var i=this.buckets[o],u=0;u<i.length;u++){var a=i[u];if(this.compareSelector(a.key)===r)return a.value}},set:function(r,o){var i=this.compareSelector(r),u=t(i);if(e(this.buckets,u))for(var a=this.buckets[u],c=0;c<a.length;c++)if(this.compareSelector(a[c].key)===i){var s=new n(r,o);return this.entryList.replace(a[c],s),a[c]=s,!0}return!1},contains:function(n){var r=this.compareSelector(n),o=t(r);if(!e(this.buckets,o))return!1;for(var i=this.buckets[o],u=0;u<i.length;u++)if(this.compareSelector(i[u].key)===r)return!0;return!1},clear:function(){this.countField=0,this.buckets={},this.entryList=new r},remove:function(n){var r=this.compareSelector(n),o=t(r);if(e(this.buckets,o))for(var i=this.buckets[o],u=0;u<i.length;u++)if(this.compareSelector(i[u].key)===r)return this.entryList.remove(i[u]),i.splice(u,1),0==i.length&&delete this.buckets[o],void this.countField--},count:function(){return this.countField},toEnumerable:function(){var e=this;return new E(function(){var t;return new g(function(){t=e.entryList.first},function(){if(null!=t){var e={key:t.key,value:t.value};return t=t.next,this.yieldReturn(e)}return!1},u.Blank)})}},o}(),A=function(e){this.count=function(){return e.count()},this.get=function(t){return E.from(e.get(t))},this.contains=function(t){return e.contains(t)},this.toEnumerable=function(){return e.toEnumerable().select(function(e){return new C(e.key,e.value)})}},C=function(e,t){this.key=function(){return e},S.call(this,t)};C.prototype=new S,"function"===p&&n(16)?void 0===(r=function(){return E}.apply(t,[]))||(e.exports=r):typeof e!==f&&e.exports?e.exports=E:o.Enumerable=E}(this)},function(e,t){(function(t){e.exports=t}).call(t,{})},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("util")}]);